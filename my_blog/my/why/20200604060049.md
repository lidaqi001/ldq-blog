# 什么是悲观锁？什么是乐观锁？

> 2020.06.04 18:00

- 什么是悲观锁？

    简单来讲就是假设所有对数据的操作都会产生冲突，所以要先加锁，再操作。具有强烈的独占和排他特性。

    一般分为两种

    - 共享锁（读锁）
        
        例如多个事务可以同用一把共享锁，**只可读，不可写**

    - 排他锁（写锁）

        顾名思义，排他锁就是不能与其他锁并存。

        例如，如果一个事务获取了一个数据行的排他锁，其他事务**就不能再获取该行的其他锁**，**包括共享锁和排他锁**，只有获取排他锁的事务**可以对数据行读取和修改**

    悲观并发控制（悲观锁）实际上是“先取锁再访问”的保守策略，为数据处理的安全提供了保证。

    - 实现方式
```text
悲观锁的实现，往往依靠数据库提供的锁机制。在数据库中，悲观锁的流程如下：

1、在对记录进行修改前，先尝试为该记录加上排他锁（exclusive locking）。
2、如果加锁失败，说明该记录正在被修改，那么当前查询可能要等待或者抛出异常。具体响应方式由开发者根据实际需要决定。
3、如果成功加锁，那么就可以对记录做修改，事务完成后就会解锁了。
4、期间如果有其他对该记录做修改或加排他锁的操作，都会等待我们解锁或直接抛出异常。
```

- 什么是乐观锁？

    正如其名，乐观，认为所有对数据的操作一般都不会产生冲突，所以只在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则返回给用户错误的信息，让用户决定如何去做。

    - 可能会产生的问题

        乐观锁可能会产生 ABA问题。

    - 实现方式
```text
使用乐观锁就不需要借助数据库的锁机制了。

乐观锁的概念中其实已经阐述了它的具体实现细节。主要就是两个步骤：冲突检测和数据更新。其实现方式有一种比较典型的就是 CAS(Compare and Swap) 。

CAS是项乐观锁技术，当多个线程尝试使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其它线程都失败，失败的线程并不会被挂起，而是被告知这次竞争中失败，并可以再次尝试。
```

- 如何选择

在乐观锁与悲观锁的选择上面，主要看下两者的区别以及适用场景就可以了。

```text
1、乐观锁并未真正加锁，效率高。一旦锁的粒度掌握不好，更新失败的概率就会比较高，容易发生业务失败。

2、悲观锁依赖数据库锁，效率低。更新失败的概率比较低。
```

随着互联网三高架构（高并发、高性能、高可用）的提出，悲观锁已经越来越少的被使用到生产环境中了，尤其是并发量比较大的业务场景。

参考链接：[简书-作者：小逼崽子你是否有很多问号](https://www.jianshu.com/p/d2ac26ca6525)